
ALTER PROCEDURE [dbo].[usp_ImportExcelReady_CL]
@ImportHeaderId INT
AS 
    BEGIN

DECLARE @LAST_PLN_LOTNO NVARCHAR(20) = ''
DECLARE @RUNNING INT = 1
DECLARE @LI_LINE_CD NVARCHAR(5) = 'CL'
DECLARE @PLN_LOTNO_PARTIAL  NVARCHAR(20) = @LI_LINE_CD + '-' + FORMAT(getdate(),'yyMM-*')
--projection 
SELECT @LAST_PLN_LOTNO = MAX(PLN_LOTNO) FROM WTS_PLAN_DESC WHERE PLN_LOTNO LIKE @PLN_LOTNO_PARTIAL + '%' --AND LI_LINE_CD = @LI_LINE_CD 

--NEW DATA FROM NEW MONTH
IF @LAST_PLN_LOTNO IS NULL
	BEGIN
		SET @RUNNING = 0
		--SET @LAST_PLN_LOTNO = @PLN_LOTNO_PARTIAL + FORMAT(@RUNNING,'0000')
	END
ELSE
	BEGIN
		SET @RUNNING = CAST(RIGHT(@LAST_PLN_LOTNO,4) AS INT)
		--SET @LAST_PLN_LOTNO = @PLN_LOTNO_PARTIAL + FORMAT(@RUNNING,'0000')
	END
SELECT @LAST_PLN_LOTNO


UPDATE [dbo].[WTS_PLAN_DESC_IMPORT]
SET PLN_LOTNO = @PLN_LOTNO_PARTIAL + FORMAT(@RUNNING,'0000'),
	PLN_SEQ = @RUNNING + 1,
	@RUNNING = @RUNNING + 1
  where ImportHeaderId=@ImportHeaderId

  
    END
